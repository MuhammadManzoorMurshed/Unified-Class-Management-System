<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Actions\Fortify\CreateNewUser;
use Illuminate\Http\JsonResponse;

class RegisterController extends Controller
{
    public function register(Request $request): JsonResponse
    {
        $input = $request->all();

        // Minimal manual validation to avoid facade/container issues in API test
        $errors = [];
        if (empty($input['name'])) $errors['name'][] = 'The name field is required.';
        if (empty($input['email']) || !filter_var($input['email'], FILTER_VALIDATE_EMAIL)) $errors['email'][] = 'A valid email is required.';
        if (empty($input['password']) || strlen($input['password']) < 8) $errors['password'][] = 'Password must be at least 8 characters.';
        if (($input['password'] ?? null) !== ($input['password_confirmation'] ?? null)) $errors['password_confirmation'][] = 'Passwords do not match.';
        if (empty($input['role_id']) || !is_numeric($input['role_id'])) $errors['role_id'][] = 'role_id is required and must be numeric.';

        if (!empty($errors)) {
            return response()->json(['success' => false, 'errors' => $errors], 422);
        }

        try {
            // Create user directly (use same fields as CreateNewUser)
            $user = \App\Models\User::create([
                'role_id' => $input['role_id'],
                'name' => $input['name'],
                'email' => $input['email'],
                'password' => \Illuminate\Support\Facades\Hash::make($input['password']),
                'phone' => $input['phone'] ?? null,
                'avatar' => null,
                'status' => 'active',
            ]);

            return response()->json(['success' => true, 'data' => $user], 201);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'message' => $e->getMessage()], 500);
        }
    }
}
